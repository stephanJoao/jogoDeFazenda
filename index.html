<!DOCTYPE html>
<html lang="pt">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Semana 06</title>
    <script src="Sprite.js"></script>
    <script src="Scene.js"></script>
    <script src="AssetsManager.js"></script>
    <script src="Map.js"></script>
</head>

<body>
    <canvas></canvas>
    <script>
        var assetsMng = new AssetsManager();
        assetsMng.loadImage("player", "assets/player.png");
        assetsMng.loadImage("inventario", "assets/inventario.png");
        assetsMng.loadImage("chao", "assets/chao.png");
        assetsMng.loadImage("wheat", "assets/wheat.png");
        assetsMng.loadImage("seed", "assets/seed.png");
        assetsMng.loadImage("trigo", "assets/trigo.png");
        assetsMng.loadImage("pao", "assets/pao.png");
        assetsMng.loadImage("foice", "assets/foice.png");
        assetsMng.loadImage("martelo", "assets/martelo.png");
        assetsMng.loadImage("mapa", "assets/mapa.png");
        assetsMng.loadImage("house", "assets/house.png");

        //assetsMng.loadAudio("explosion", "assets/explosion.mp3");
        //assetsMng.loadAudio("shot", "assets/shot.mp3");

        var canvas = document.querySelector("canvas");
        var ctx = canvas.getContext("2d");
        canvas.width = 32 * 28;
        canvas.height = 32 * 20;

        var teclas = {
            esquerda: 0,
            cima: 0,
            direita: 0,
            baixo: 0,
            espaco: 0,
            e: 0,
            a: 0,
            d: 0,
            shift: 0
        }

        var mapa = new Map({
            COLUMNS: 28, LINES: 20, m:
                [
                    [2.0, 2.1, 3.0, 3.0, 3.0, 3.0, 2.0, 2.1, 2.0, 2.1, 2.0, 2.1, 2.0, 2.1, 2.0, 2.1, 2.0, 2.1, 2.0, 2.1, 2.0, 2.1, 2.0, 2.1, 2.0, 2.1, 2.0, 2.1],
                    [2.1, 2.0, 3.0, 3.0, 3.0, 3.0, 2.2, 2.5, 2.2, 2.5, 2.2, 2.5, 2.2, 2.5, 2.2, 2.5, 2.2, 2.5, 2.2, 2.5, 2.2, 2.5, 2.2, 2.5, 2.2, 2.5, 2.1, 2.0],
                    [2.0, 2.2, 3.0, 3.0, 3.0, 3.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 2.5, 2.1],
                    [2.1, 2.3, 3.1, 3.2, 3.2, 3.3, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 2.4, 2.0],
                    [2.0, 2.2, 3.4, 3.0, 3.0, 3.5, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.9, 0.0, 0.0, 0.0, 2.5, 2.1],
                    [2.1, 2.3, 3.6, 3.9, 3.7, 3.8, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.9, 0.9, 0.9, 0.0, 0.0, 0.0, 2.4, 2.0],
                    [2.0, 2.2, 0.0, 0.0, 0.1, 0.2, 0.2, 0.2, 0.2, 0.2, 0.2, 0.3, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.9, 0.0, 0.0, 0.0, 0.0, 2.5, 2.1],
                    [2.1, 2.3, 0.0, 0.0, 0.4, 4.0, 4.0, 4.0, 4.0, 4.0, 4.0, 0.5, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 2.4, 2.0],
                    [2.0, 2.2, 0.0, 0.0, 0.4, 4.0, 4.0, 4.0, 4.0, 4.0, 4.0, 0.5, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 2.5, 2.1],
                    [2.1, 2.3, 0.0, 0.0, 0.4, 4.0, 4.0, 4.0, 4.0, 4.0, 4.0, 0.5, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 2.4, 2.0],
                    [2.0, 2.2, 0.0, 0.0, 0.4, 4.0, 4.0, 4.0, 4.0, 4.0, 4.0, 0.5, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 2.5, 2.1],
                    [2.1, 2.3, 0.0, 0.0, 0.4, 4.0, 4.0, 4.0, 4.0, 4.0, 4.0, 0.5, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 2.4, 2.0],
                    [2.0, 2.2, 0.0, 0.0, 0.4, 4.0, 4.0, 4.0, 4.0, 4.0, 4.0, 0.5, 0.0, 0.0, 0.0, 0.9, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 2.5, 2.1],
                    [2.1, 2.3, 0.0, 0.0, 0.4, 4.0, 4.0, 4.0, 4.0, 4.0, 4.0, 0.5, 0.0, 0.0, 0.9, 0.9, 0.9, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 2.4, 2.0],
                    [2.0, 2.2, 0.0, 0.0, 0.4, 4.0, 4.0, 4.0, 4.0, 4.0, 4.0, 0.5, 0.0, 0.0, 0.0, 0.9, 0.9, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.9, 0.9, 0.0, 2.5, 2.1],
                    [2.1, 2.3, 0.0, 0.0, 0.6, 0.7, 0.7, 0.7, 0.7, 0.7, 0.7, 0.8, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.9, 0.0, 2.4, 2.0],
                    [2.0, 2.2, 0.9, 0.0, 0.9, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.9, 0.0, 2.5, 2.1],
                    [2.1, 2.3, 0.9, 0.9, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.9, 2.4, 2.0],
                    [2.0, 2.1, 2.3, 2.4, 2.3, 2.4, 2.3, 2.4, 2.3, 2.4, 2.3, 2.4, 2.3, 2.4, 2.3, 2.4, 2.3, 2.4, 2.3, 2.4, 2.3, 2.4, 2.3, 2.4, 2.3, 2.4, 2.0, 2.1],
                    [2.1, 2.0, 2.1, 2.0, 2.1, 2.0, 2.1, 2.0, 2.1, 2.0, 2.1, 2.0, 2.1, 2.0, 2.1, 2.0, 2.1, 2.0, 2.1, 2.0, 2.1, 2.0, 2.1, 2.0, 2.1, 2.0, 2.1, 2.0],
                ],
        });

        var cena1 = new Scene({ ctx: ctx, w: canvas.width, h: canvas.height, assets: assetsMng, map: mapa });

        var pc = new Sprite({
            x: 250,
            y: 150,
            w: 22,
            h: 14,
            comportar: porTeclasDirecionais(teclas),
            frameLimit: 9,
            props: { tipo: "pc" },
            inventario: { sementes: 3, trigo: 0, pao: 0, opacidade: 1 },
            cooldowns: { plantar: 0, arar: 0, cansado: 4, stamina: 0, recuperacao: 0, cansou: false, acoes: 0 },
            status: { correndo: false }
        });

        cena1.adicionar(pc);

        function porTeclasDirecionais(teclas) {
            return function () {
                if (teclas.esquerda && !teclas.cima && !teclas.baixo && this.cooldowns.acoes <= 0) {
                    this.vx = -90;
                    this.pose = 9;
                    this.direcao = "esquerda";
                }
                if (teclas.direita && !teclas.cima && !teclas.baixo && this.cooldowns.acoes <= 0) {
                    this.vx = +90;
                    this.pose = 11;
                    this.direcao = "direita";
                }
                if (teclas.esquerda === teclas.direita && this.vy == 0 && this.cooldowns.acoes <= 0) {
                    this.vx = 0;
                    if (teclas.esquerda) {
                        if (Math.floor(this.y / 32) >= mapa.LINES / 2) {
                            this.pose = 8;
                            this.direcao = "cima";
                        }
                        else {
                            this.pose = 10;
                            this.direcao = "baixo";
                        }

                    }
                }
                if (teclas.cima && !teclas.esquerda && !teclas.direita && this.cooldowns.acoes <= 0) {
                    this.vy = -90;
                    this.pose = 8;
                    this.direcao = "cima";
                }
                if (teclas.baixo && !teclas.esquerda && !teclas.direita && this.cooldowns.acoes <= 0) {
                    this.vy = +90;
                    this.pose = 10;
                    this.direcao = "baixo";
                }
                if (teclas.cima === teclas.baixo && this.vx == 0 && this.cooldowns.acoes <= 0) {
                    this.vy = 0;
                    if (teclas.cima) {
                        if (Math.floor(this.x / 32) >= mapa.COLUMNS / 2) {
                            this.pose = 9;
                            this.direcao = "esquerda";
                        }
                        else {
                            this.pose = 11;
                            this.direcao = "direita";
                        }
                    }
                }

                if (teclas.e) {

                }

                if (teclas.shift && this.cooldowns.acoes <= 0) {
                    if (!this.cooldowns.cansou) {
                        if (this.vx != 0) {
                            if (this.vx > 0)
                                this.vx = 240;
                            else
                                this.vx = -240;
                            this.status.correndo = true;
                            this.cooldowns.stamina += 5 * dt;
                        }
                        else if (this.vy != 0) {
                            if (this.vy > 0)
                                this.vy = 240;
                            else
                                this.vy = -240;
                            this.status.correndo = true;
                            this.cooldowns.stamina += 5 * dt;
                        }
                        if (this.cooldowns.stamina > this.cooldowns.cansado) {
                            this.cooldowns.cansou = true;
                            this.status.correndo = false;
                        }
                    }
                }

                if (teclas.a) {
                    this.inventario.opacidade = 1.3;
                    teclas.a = 0;
                    this.acao--;
                    if (this.acao == -1)
                        this.acao = 4;
                }

                if (teclas.d) {
                    this.inventario.opacidade = 1.3;
                    teclas.d = 0;
                    this.acao++;
                    if (this.acao == 5)
                        this.acao = 0;
                }

                if (teclas.espaco && this.cooldowns.acoes <= 0) {
                    var esq = mapa.cells[Math.floor(this.x / 32) - 1][Math.floor(this.y / 32)].tipo;
                    var dir = mapa.cells[Math.floor(this.x / 32) + 1][Math.floor(this.y / 32)].tipo;
                    var cima = mapa.cells[Math.floor(this.x / 32)][Math.floor(this.y / 32) - 1].tipo;
                    var baixo = mapa.cells[Math.floor(this.x / 32)][Math.floor(this.y / 32) + 1].tipo;
                    var atual = mapa.cells[Math.floor(this.x / 32)][Math.floor(this.y / 32)].tipo;

                    switch (this.acao) {
                        case 0:
                            if (atual == 4.0 && this.inventario.sementes > 0 && this.cooldowns.plantar <= 0) {
                                mapa.cells[Math.floor(this.x / 32)][Math.floor(this.y / 32)].tipo = 4.1;
                                mapa.cells[Math.floor(this.x / 32)][Math.floor(this.y / 32)].dtCells = 0;
                                this.cooldowns.acoes = 0.6;
                                this.cooldowns.plantar = 0.5;
                                this.inventario.sementes--;
                            }
                            break;

                        case 1:
                            break;

                        case 2:
                            break;

                        case 3:
                            if (this.cooldowns.arar <= 0) {
                                if (this.direcao === "esquerda" && (esq == 4.1 || esq == 4.2 || esq == 4.3  || esq == 4.4)) {
                                    mapa.cells[Math.floor(this.x / 32) - 1][Math.floor(this.y / 32)].tipo = 4.0;
                                    if (esq == 4.1 || esq == 4.2 || esq == 4.3) {
                                        this.inventario.sementes += 1;
                                    }
                                    else {
                                        this.inventario.sementes += 1 + Math.floor(Math.random() * 2);
                                        this.inventario.trigo += 1 + Math.floor(Math.random() * 2);
                                    }
                                    this.cooldowns.arar = 0.7;
                                    this.cooldowns.acoes = 0.8;
                                    this.pose = 13;
                                    this.frameLimit = 6;
                                    this.frame = this.frameLimit - 1;
                                }
                                else if (this.direcao === "direita" && (dir == 4.1 || dir == 4.2 || dir == 4.3 || dir == 4.4)) {
                                    mapa.cells[Math.floor(this.x / 32) + 1][Math.floor(this.y / 32)].tipo = 4.0;
                                    if (dir == 4.1 || dir == 4.2 || dir == 4.3) {
                                        this.inventario.sementes += 1;
                                    }
                                    else {
                                        this.inventario.sementes += 1 + Math.floor(Math.random() * 2);
                                        this.inventario.trigo += 1 + Math.floor(Math.random() * 2);
                                    }
                                    this.cooldowns.arar = 0.7;
                                    this.cooldowns.acoes = 0.8;
                                    this.pose = 15;
                                    this.frameLimit = 6;
                                    this.frame = this.frameLimit - 1;
                                }
                                else if (this.direcao === "cima" && (cima == 4.1 || cima == 4.2 || cima == 4.3 || cima == 4.4)) {
                                    mapa.cells[Math.floor(this.x / 32)][Math.floor(this.y / 32) - 1].tipo = 4.0;
                                    if (cima == 4.1 || cima == 4.2 || cima == 4.3) {
                                        this.inventario.sementes += 1;
                                    }
                                    else {
                                        this.inventario.sementes += 1 + Math.floor(Math.random() * 2);
                                        this.inventario.trigo += 1 + Math.floor(Math.random() * 2);
                                    }
                                    this.cooldowns.arar = 0.7;
                                    this.cooldowns.acoes = 0.8;
                                    this.pose = 12;
                                    this.frameLimit = 6;
                                    this.frame = this.frameLimit - 1;
                                }
                                else if (this.direcao === "baixo" && (baixo == 4.1 || baixo == 4.2 || baixo == 4.3 || baixo == 4.4)) {
                                    mapa.cells[Math.floor(this.x / 32)][Math.floor(this.y / 32) + 1].tipo = 4.0;
                                    if (baixo == 4.1 || baixo == 4.2 || baixo == 4.3) {
                                        this.inventario.sementes += 1;
                                    }
                                    else {
                                        this.inventario.sementes += 1 + Math.floor(Math.random() * 2);
                                        this.inventario.trigo += 1 + Math.floor(Math.random() * 2);
                                    }
                                    this.cooldowns.arar = 0.7;
                                    this.cooldowns.acoes = 0.8;
                                    this.pose = 14;
                                    this.frameLimit = 6;
                                    this.frame = this.frameLimit - 1;
                                }
                            }
                            break;
                        case 4:
                            break;
                    }
                }
            }
        }

        addEventListener("keydown", function (e) {
            console.log(e.keyCode);
            switch (e.keyCode) {
                case 32:
                    teclas.espaco = 1;
                    break;
                case 37:
                    teclas.esquerda = 1;
                    break;
                case 38:
                    teclas.cima = 1;
                    break;
                case 39:
                    teclas.direita = 1;
                    break;
                case 40:
                    teclas.baixo = 1;
                    break;
                case 69:
                    teclas.e = 1;
                    break;
                case 65:
                    teclas.a = 1;
                    break;
                case 68:
                    teclas.d = 1;
                    break;
                case 16:
                    teclas.shift = 1;
                    break;
            }
        });

        addEventListener("keyup", function (e) {
            switch (e.keyCode) {
                case 32:
                    teclas.espaco = 0;
                    break;
                case 37:
                    teclas.esquerda = 0;
                    break;
                case 38:
                    teclas.cima = 0;
                    break;
                case 39:
                    teclas.direita = 0;
                    break;
                case 40:
                    teclas.baixo = 0;
                    break;
                case 69:
                    teclas.e = 0;
                    break;
                case 16:
                    teclas.shift = 0;
                    pc.status.correndo = false;
                    break;
            }
        });

        function inventario() {
            ctx.strokeStyle = "black";
            if (pc.inventario.opacidade < 0)
                ctx.globalAlpha = 0;
            else
                ctx.globalAlpha = pc.inventario.opacidade;
            for (var i = 0; i < 5; i++) {
                if (pc.acao === i) {
                    ctx.lineWidth = 5;
                    ctx.drawImage(
                        cena1.assets.img("inventario"),
                        0,
                        32,
                        32,
                        32,
                        pc.x - 80 + 32 * i,
                        pc.y + 20,
                        32,
                        32
                    );
                } else {
                    ctx.lineWidth = 2;
                    ctx.drawImage(
                        cena1.assets.img("inventario"),
                        0,
                        0,
                        32,
                        32,
                        pc.x - 80 + 32 * i,
                        pc.y + 20,
                        32,
                        32
                    );
                }
                ctx.drawImage(
                    cena1.assets.img("seed"),
                    0,
                    0,
                    32,
                    32,
                    pc.x - 75,
                    pc.y + 27,
                    22,
                    22
                );
                ctx.drawImage(
                    cena1.assets.img("trigo"),
                    0,
                    0,
                    150,
                    150,
                    pc.x + 32 - 74,
                    pc.y + 25,
                    22,
                    22
                );
                ctx.drawImage(
                    cena1.assets.img("pao"),
                    0,
                    0,
                    150,
                    150,
                    pc.x + 64 - 75,
                    pc.y + 25,
                    22,
                    22
                );
                ctx.drawImage(
                    cena1.assets.img("foice"),
                    0,
                    0,
                    64,
                    58,
                    pc.x + 96 - 76,
                    pc.y + 25,
                    23,
                    23
                );
                ctx.drawImage(
                    cena1.assets.img("martelo"),
                    0,
                    0,
                    64,
                    56,
                    pc.x + 129 - 77,
                    pc.y + 25,
                    22,
                    22
                );
                ctx.fillStyle = "white";
                ctx.fillText(pc.inventario.sementes, pc.x - 67, pc.y + 46);
                ctx.fillText(pc.inventario.trigo, pc.x - 67 + 32, pc.y + 46);
                ctx.fillText(pc.inventario.pao, pc.x - 67 + 64, pc.y + 46);
            }
            ctx.globalAlpha = 1;
        }

        function passo(t) {
            dt = (t - anterior) / 1000;
            if (assetsMng.progresso() === 100) {
                cena1.passo(dt);
            }
            anterior = t;
            ctx.fillStyle = "black";
            ctx.fillText(1 / dt, 10, 20);
            ctx.fillText(`Sementes: ${pc.inventario.sementes}`, 40, 50);
            ctx.fillText(`Trigo: ${pc.inventario.trigo}`, 40, 60);
            ctx.fillText(`Pao: ${pc.inventario.pao}`, 40, 70);
            ctx.fillText(pc.acao, 40, 90);
            ctx.fillText(pc.cooldowns.stamina, 40, 110);
            ctx.fillText(pc.cooldowns.acoes, 40, 120);
            inventario();
            requestAnimationFrame(passo);

        }

        var dt, anterior = 0;
        requestAnimationFrame(passo);

    </script>
</body>

</html>