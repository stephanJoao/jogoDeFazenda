<!DOCTYPE html>
<html lang="pt">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Semana 06</title>
    <script src="Sprite.js"></script>
    <script src="Scene.js"></script>
    <script src="AssetsManager.js"></script>
    <script src="Map.js"></script>
</head>

<body>
    <canvas></canvas>
    <script>
        var assetsMng = new AssetsManager();
        assetsMng.loadImage("player", "assets/player.png");
        //assetsMng.loadImage("enemy_1", "assets/enemy_1.png");
        //assetsMng.loadImage("explosion", "assets/explosion.png");
        //assetsMng.loadAudio("explosion", "assets/explosion.mp3");
        //assetsMng.loadAudio("shot", "assets/shot.mp3");

        var canvas = document.querySelector("canvas");
        var ctx = canvas.getContext("2d");
        canvas.width = 32 * 28;
        canvas.height = 32 * 20;


        var teclas = {
            esquerda: 0,
            cima: 0,
            direita: 0,
            baixo: 0,
            espaco: 0,
            e: 0
        }

        var mapa = new Map({
            COLUMNS: 28, LINES: 20, m:
                [
                    [2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2],
                    [2, 3, 3, 3, 3, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2],
                    [2, 3, 3, 3, 3, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2],
                    [2, 3, 3, 3, 3, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2],
                    [2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2],
                    [2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 2],
                    [2, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 2],
                    [2, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 2],
                    [2, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 2],
                    [2, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 2],
                    [2, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 2],
                    [2, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 0, 0, 2],
                    [2, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 0, 0, 2],
                    [2, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2],
                    [2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2],
                    [2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2],
                    [2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2],
                    [2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2],
                    [2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2],
                    [2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2],
                ]
        });

        var cena1 = new Scene({ ctx: ctx, w: canvas.width, h: canvas.height, assets: assetsMng, map: mapa });

        var pc = new Sprite({
            x: 250,
            y: 150,
            w: 22,
            h: 14,
            comportar: porTeclasDirecionais(teclas),
            props: { tipo: "pc" }
        });

        cena1.adicionar(pc);

        function porTeclasDirecionais(teclas) {
            return function () {
                if (teclas.esquerda && pc.vy == 0) {
                    this.vx = -90;
                    this.pose = 9;
                    this.direcao = "esquerda";
                }
                if (teclas.direita && pc.vy == 0) {
                    this.vx = +90;
                    this.pose = 11;
                    this.direcao = "direita";
                }
                if (teclas.esquerda === teclas.direita) {
                    this.vx = 0;
                    if (teclas.esquerda) {
                        if (Math.floor(pc.y / 32) >= mapa.LINES / 2)
                            this.pose = 8;
                        else
                            this.pose = 10;
                    }
                }
                if (teclas.cima && pc.vx == 0) {
                    this.vy = -90;
                    this.pose = 8;
                    this.direcao = "cima";
                }
                if (teclas.baixo && pc.vx == 0) {
                    this.vy = +90;
                    this.pose = 10;
                    this.direcao = "baixo";
                }
                if (teclas.cima === teclas.baixo) {
                    this.vy = 0;
                    if (teclas.cima) {

                        if (Math.floor(pc.x / 32) >= mapa.COLUMNS / 2)
                            this.pose = 9;
                        else
                            this.pose = 11;
                    }
                }

                if (teclas.espaco && this.cooldown <= 0) {
                    mapa.cells[Math.floor(pc.x / 32)][Math.floor(pc.y / 32)].tipo = 1;
                    mapa.cells[Math.floor(pc.x / 32)][Math.floor(pc.y / 32)].dtCells = 0;
                }
                if (teclas.e) {
                    mapa.cells[Math.floor(pc.x / 32)][Math.floor(pc.y / 32)].tipo = 0;
                    mapa.cells[Math.floor(pc.x / 32) - 1][Math.floor(pc.y / 32)].tipo = 0;
                    mapa.cells[Math.floor(pc.x / 32) + 1][Math.floor(pc.y / 32)].tipo = 0;
                    mapa.cells[Math.floor(pc.x / 32)][Math.floor(pc.y / 32) + 1].tipo = 0;
                    mapa.cells[Math.floor(pc.x / 32)][Math.floor(pc.y / 32) - 1].tipo = 0;
                }
            }
        }
        addEventListener("keydown", function (e) {
            switch (e.keyCode) {
                case 32:
                    teclas.espaco = 1;
                    break;
                case 37:
                    teclas.esquerda = 1;
                    break;
                case 38:
                    teclas.cima = 1;
                    break;
                case 39:
                    teclas.direita = 1;
                    break;
                case 40:
                    teclas.baixo = 1;
                    break;
                case 69:
                    teclas.e = 1;
                    break;
            }
        });
        addEventListener("keyup", function (e) {
            switch (e.keyCode) {
                case 32:
                    teclas.espaco = 0;
                    break;
                case 37:
                    teclas.esquerda = 0;
                    break;
                case 38:
                    teclas.cima = 0;
                    break;
                case 39:
                    teclas.direita = 0;
                    break;
                case 40:
                    teclas.baixo = 0;
                    break;
                case 69:
                    teclas.e = 0;
                    break;
            }
        });

        function passo(t) {
            dt = (t - anterior) / 1000;
            if (assetsMng.progresso() === 100) {
                cena1.passo(dt);

            }
            anterior = t;
            ctx.fillText(1 / dt, 10, 20);
            requestAnimationFrame(passo);
        }

        var dt, anterior = 0;
        requestAnimationFrame(passo);


    </script>
</body>

</html>