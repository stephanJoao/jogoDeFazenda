<!DOCTYPE html>
<html lang="pt">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Semana 06</title>
    <script src="Sprite.js"></script>
    <script src="Scene.js"></script>
    <script src="AssetsManager.js"></script>
    <script src="Map.js"></script>
</head>

<body>
    <canvas></canvas>
    <script>
        var assetsMng = new AssetsManager();
        assetsMng.loadImage("player", "assets/player.png");
        assetsMng.loadImage("inventario", "assets/inventario.png");
        //assetsMng.loadImage("enemy_1", "assets/enemy_1.png");
        //assetsMng.loadImage("explosion", "assets/explosion.png");
        //assetsMng.loadAudio("explosion", "assets/explosion.mp3");
        //assetsMng.loadAudio("shot", "assets/shot.mp3");

        var canvas = document.querySelector("canvas");
        var ctx = canvas.getContext("2d");
        canvas.width = 32 * 28;
        canvas.height = 32 * 20;

        var teclas = {
            esquerda: 0,
            cima: 0,
            direita: 0,
            baixo: 0,
            espaco: 0,
            e: 0,
            a: 0,
            d: 0,
        }

        var mapa = new Map({
            COLUMNS: 28, LINES: 20, m:
                [
                    [2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2],
                    [2, 3, 3, 3, 3, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2],
                    [2, 3, 3, 3, 3, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2],
                    [2, 3, 3, 3, 3, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2],
                    [2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2],
                    [2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2],
                    [2, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2],
                    [2, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2],
                    [2, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2],
                    [2, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2],
                    [2, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2],
                    [2, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2],
                    [2, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2],
                    [2, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2],
                    [2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2],
                    [2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2],
                    [2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2],
                    [2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2],
                    [2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2],
                    [2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2],
                ]
        });

        var cena1 = new Scene({ ctx: ctx, w: canvas.width, h: canvas.height, assets: assetsMng, map: mapa });

        var pc = new Sprite({
            x: 250,
            y: 150,
            w: 22,
            h: 14,
            comportar: porTeclasDirecionais(teclas),
            props: { tipo: "pc" },
            inventario: { sementes: 0, trigo: 0, pao: 0, opacidade: 1 }
        });

        cena1.adicionar(pc);

        function porTeclasDirecionais(teclas) {
            return function () {
                if (teclas.esquerda && !teclas.cima && !teclas.baixo) {
                    this.vx = -90;
                    this.pose = 9;
                    this.direcao = "esquerda";
                }
                if (teclas.direita && !teclas.cima && !teclas.baixo) {
                    this.vx = +90;
                    this.pose = 11;
                    this.direcao = "direita";
                }
                if (teclas.esquerda === teclas.direita && this.vy == 0) {
                    this.vx = 0;
                    if (teclas.esquerda) {
                        if (Math.floor(pc.y / 32) >= mapa.LINES / 2) {
                            this.pose = 8;
                            this.direcao = "cima";
                        }
                        else {
                            this.pose = 10;
                            this.direcao = "baixo";
                        }

                    }
                }
                if (teclas.cima && !teclas.esquerda && !teclas.direita) {
                    this.vy = -90;
                    this.pose = 8;
                    this.direcao = "cima";
                }
                if (teclas.baixo && !teclas.esquerda && !teclas.direita) {
                    this.vy = +90;
                    this.pose = 10;
                    this.direcao = "baixo";
                }
                if (teclas.cima === teclas.baixo && this.vx == 0) {
                    this.vy = 0;
                    if (teclas.cima) {
                        if (Math.floor(pc.x / 32) >= mapa.COLUMNS / 2) {
                            this.pose = 9;
                            this.direcao = "esquerda";
                        }
                        else {
                            this.pose = 11;
                            this.direcao = "direita";
                        }
                    }
                }

                if (teclas.e && this.cooldown <= 0) {
                }

                if (teclas.a) {
                    pc.inventario.opacidade = 1.2;
                    teclas.a = 0;
                    pc.acao--;
                    if (pc.acao == -1)
                        pc.acao = 3;
                }

                if (teclas.d) {
                    pc.inventario.opacidade = 1.2;
                    teclas.d = 0;
                    pc.acao++;
                    if (pc.acao == 4)
                        pc.acao = 0;
                }

                if (teclas.espaco) {
                    var esq = mapa.cells[Math.floor(pc.x / 32) - 1][Math.floor(pc.y / 32)].tipo;
                    var dir = mapa.cells[Math.floor(pc.x / 32) + 1][Math.floor(pc.y / 32)].tipo;
                    var cima = mapa.cells[Math.floor(pc.x / 32)][Math.floor(pc.y / 32) - 1].tipo;
                    var baixo = mapa.cells[Math.floor(pc.x / 32)][Math.floor(pc.y / 32) + 1].tipo;
                    var atual = mapa.cells[Math.floor(pc.x / 32)][Math.floor(pc.y / 32)].tipo;

                    switch (pc.acao) {
                        case 0:
                            if (atual == 0 && pc.inventario.sementes > 0 && pc.cooldown <= 0) {
                                mapa.cells[Math.floor(pc.x / 32)][Math.floor(pc.y / 32)].tipo = 1;
                                mapa.cells[Math.floor(pc.x / 32)][Math.floor(pc.y / 32)].dtCells = 0;
                                this.cooldown = 0.5;
                                pc.inventario.sementes--;
                            }
                            break;

                        case 1:
                            break;

                        case 2:
                            break;

                        case 3:
                            if (this.direcao === "esquerda" && (esq == 1 || esq == 4 || esq == 5 || esq == 6)) {
                                mapa.cells[Math.floor(pc.x / 32) - 1][Math.floor(pc.y / 32)].tipo = 0;
                                if (esq == 1 || esq == 4 || esq == 5) {
                                    pc.inventario.sementes += 1;
                                }
                                else {
                                    pc.inventario.sementes += 1 + Math.floor(Math.random() * 2);
                                    pc.inventario.trigo += 1 + Math.floor(Math.random() * 2);
                                }
                            }
                            else if (this.direcao === "direita" && (dir == 1 || dir == 4 || dir == 5 || dir == 6)) {
                                mapa.cells[Math.floor(pc.x / 32) + 1][Math.floor(pc.y / 32)].tipo = 0;
                                if (dir == 1 || dir == 4 || dir == 5) {
                                    pc.inventario.sementes += 1;
                                }
                                else {
                                    pc.inventario.sementes += 1 + Math.floor(Math.random() * 2);
                                    pc.inventario.trigo += 1 + Math.floor(Math.random() * 2);
                                }
                            }
                            else if (this.direcao === "cima" && (cima == 1 || cima == 4 || cima == 5 || cima == 6)) {
                                mapa.cells[Math.floor(pc.x / 32)][Math.floor(pc.y / 32) - 1].tipo = 0;
                                if (cima == 1 || cima == 4 || cima == 5) {
                                    pc.inventario.sementes += 1;
                                }
                                else {
                                    pc.inventario.sementes += 1 + Math.floor(Math.random() * 2);
                                    pc.inventario.trigo += 1 + Math.floor(Math.random() * 2);
                                }
                            }
                            else if (this.direcao === "baixo" && (baixo == 1 || baixo == 4 || baixo == 5 || baixo == 6)) {
                                mapa.cells[Math.floor(pc.x / 32)][Math.floor(pc.y / 32) + 1].tipo = 0;
                                if (baixo == 1 || baixo == 4 || baixo == 5) {
                                    pc.inventario.sementes += 1;
                                }
                                else {
                                    pc.inventario.sementes += 1 + Math.floor(Math.random() * 2);
                                    pc.inventario.trigo += 1 + Math.floor(Math.random() * 2);
                                }
                            }
                            break;
                    }
                }
            }
        }

        addEventListener("keydown", function (e) {
            console.log(e.keyCode);
            switch (e.keyCode) {
                case 32:
                    teclas.espaco = 1;
                    break;
                case 37:
                    teclas.esquerda = 1;
                    break;
                case 38:
                    teclas.cima = 1;
                    break;
                case 39:
                    teclas.direita = 1;
                    break;
                case 40:
                    teclas.baixo = 1;
                    break;
                case 69:
                    teclas.e = 1;
                    break;
                case 65:
                    teclas.a = 1;
                    break;
                case 68:
                    teclas.d = 1;
                    break;
            }
        });

        addEventListener("keyup", function (e) {
            switch (e.keyCode) {
                case 32:
                    teclas.espaco = 0;
                    break;
                case 37:
                    teclas.esquerda = 0;
                    break;
                case 38:
                    teclas.cima = 0;
                    break;
                case 39:
                    teclas.direita = 0;
                    break;
                case 40:
                    teclas.baixo = 0;
                    break;
                case 69:
                    teclas.e = 0;
                    break;
            }
        });

        function inventario() {
            ctx.strokeStyle = "black";
            if (pc.inventario.opacidade < 0)
                ctx.globalAlpha = 0;
            else
                ctx.globalAlpha = pc.inventario.opacidade;
            for (var i = 0; i < 4; i++) {
                if (pc.acao === i) {
                    ctx.lineWidth = 5;
                    ctx.drawImage(
                       cena1.assets.img("inventario"),
                        0, //linha
                        32, //coluna
                        32,                        //tamanho na imagem x
                        32,                        //tamanho na imagem y
                        pc.x - 32 * 2 + 32 * i,                  //posicao em x
                        pc.y + 30,                       //posicao em y
                        32,                        //tamanho no canvas x
                        32                         //tamanho no canvas y
                    );
                }
                else {
                    ctx.lineWidth = 2;
                    ctx.drawImage(
                        cena1.assets.img("inventario"),
                        0, //linha
                        0, //coluna
                        32,                        //tamanho na imagem x
                        32,                        //tamanho na imagem y
                        pc.x - 32 * 2 + 32 * i,                  //posicao em x
                        pc.y + 30,                       //posicao em y
                        32,                        //tamanho no canvas x
                        32                         //tamanho no canvas y
                    );
                }
                //ctx.strokeRect(pc.x - 32 * 2 + 32 * i, pc.y + 30, 32, 32);
            }
            ctx.globalAlpha = 1;
        }

        function passo(t) {
            dt = (t - anterior) / 1000;
            if (assetsMng.progresso() === 100) {
                cena1.passo(dt);
            }
            anterior = t;
            ctx.fillStyle = "black";
            ctx.fillText(1 / dt, 10, 20);
            ctx.fillText(`Sementes: ${pc.inventario.sementes}`, 40, 50);
            ctx.fillText(`Trigo: ${pc.inventario.trigo}`, 40, 60);
            ctx.fillText(`Pao: ${pc.inventario.pao}`, 40, 70);
            ctx.fillText(pc.acao, 40, 90);
            inventario();
            requestAnimationFrame(passo);
        }

        var dt, anterior = 0;
        requestAnimationFrame(passo);

    </script>
</body>

</html>